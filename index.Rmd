## Course: Visual Analytics for Policy and Management
### Final Project
####Group 3: Dave Coomes, Quinhas Fernndes, Isabella Sun, Long Zong

### 
### 

####*WRITE INTRODUCTION* what is the data? what is the story?
### 
### 

####Figures:

1. [Mozambique Community Health Workers contribuition on Family Planning](#fig1)

2. [Box Plot: Average number of supervision per community health worker](#fig2)

3. [Scatter Plot: Supervision v Contribution (we can come up with a better name later)](#fig3)

4. [Scatter Plot: active chw v Contribution (we can come up with a better name later)](#fig4)

5. [Map: Under 5 mortality rate by province in 2010](#fig5)

6. [Map: Change in under 5 mortality rate from 2000-2010 by province](#fig6)

<br>

First, we bring in the dataset we will use and load libraries. 
```{r setup, warning=FALSE, message=FALSE}

knitr::opts_chunk$set(echo = TRUE, warnings=FALSE, message=FALSE)

if (!require(ggrepel)) install.packages("ggrepel", repos = "http://cran.us.r-project.org")
library(ggplot2)
library(ggrepel)
library(foreign)
library(haven)

link="https://github.com/quinhasf/pubpol-599/raw/master/ape_analysis.dta"
chw_fp <- read_dta(url(link))
```

<br>

###Lollipop Plot 
We will create a plot showing how above or below different provinces are relative to the 10% target goal.

Create data frame for ggplot to plot our lolipop plot
```{r ggplot}
chw_pf1 <- data.frame(chw_fp[c('province', 'ape_contrib')])

tableFreq=as.data.frame(chw_pf1)

names(tableFreq)=c("province","ape_contrib")

tableFreqO=tableFreq[order(tableFreq$ape_contrib),]

tableFreqO$gap=tableFreqO$ape_contrib-10

tableFreqO$Target=ifelse(tableFreqO$gap>0,"Above Target","Below Target")

```

Misc table elements: title, subtitle, caption
```{r}

loli_title = "Mozambique Community Health Workers contribuition on Family Planning"

loli_subtitle = "2017 province level gap on CHW contribuition"

loli_caption = "Fig.1: Represents the contirbution of each province to achieve the 10% target (centered at 0)
in 2017 (Gap analysis). Provinces are ploted from low to high perfomance.

Source: Health Information System"

```

Create Loliplot 
<a id='fig1'></a>
```{r lolliplot}
base = ggplot(tableFreqO, aes(province,gap,color=Target,
                              label = round(gap,1))) 
lolliplot1=base + geom_segment(aes(y =0, 
                                   x = province, 
                                   yend = gap, 
                                   xend = province)) 
lolliplot2=lolliplot1 + geom_point()

lolliplot3= lolliplot2 + scale_x_discrete(limits=tableFreqO$province) 

lollitplot4 = lolliplot3 + geom_text(size=3, nudge_x=0.35, nudge_y=0.1,show.legend = FALSE) +
              labs(title = loli_title,
                   subtitle = loli_subtitle,
                    x ="Province", 
                    y = "% points of the FP GAP",
                    caption = loli_caption) +
            theme(panel.background = element_rect(fill = "gray98",
                                                    colour = "black"),
                    plot.caption = element_text(hjust = 0), 
                    plot.title = element_text(hjust = 0.5),
                    plot.subtitle = element_text(hjust=0.5),
                    legend.box.just = c("right","center"), 
                    axis.text.x = element_text(size=7, angle = 60, vjust = 1, hjust=1)) +
              geom_hline(yintercept=0,
                    linetype="dashed",
                    color = "black",
                    size= 0.9,
                    alpha= 0.8)


lollitplot4 
```

<br>

###Box Plot: Average number of supervision per community health worker

```{r}
chw_fp$aver_sup_chw <- chw_fp$n_supervision / chw_fp$report_ape
```

```{r}
boxplot_title = "Distribution of average number of supervisions per community health worker"

source = "Source: Health Information System"
```

<a id='fig2'></a>
```{r}
base = ggplot(chw_fp,aes(y=aver_sup_chw, x='')) 
box1  = base + geom_boxplot()

box2 = box1 + labs(title=boxplot_title,
                     x =NULL, 
                     y = 'Number of supervisions per community health worker',
                     caption = source)
box3= box2 + scale_y_continuous(breaks=1:15)

box4 = box3 + theme(panel.background = element_rect(fill = "white",
                                                    colour = "grey50"),
                    plot.title = element_text(hjust = 0.5),
                    plot.caption = element_text(hjust=0))
box4+ coord_flip()

```


<br>

###SCATTER 1
<a id='fig3'></a>
```{r}
scat1_title = " title..."
```

```{r}
base = ggplot(chw_fp, aes(x=report_ape, y=ape_contrib, label=province)) + 
    geom_point() + geom_text_repel()

scat1 = base + labs(title=scat1_title,
                     x ="Total women of reproductive age", 
                     y = 'Community health worker contribution',
                     caption = source)
scat1 

```

<br>

###SCATTER 2
<a id='fig4'></a>
```{r}
scat2_title = " Average Number of Active CHW to Each Province's Contribution"
base111=ggplot(data=chw_fp,aes (x=report_ape,
                             y=ape_contrib, label=province))+geom_point(size=3)+ geom_text_repel()
base111=base111+labs(title=scat2_title,
                     x ="Average Number of Active CHW", 
                     y = 'Contribution in Each Province',
                     caption = source)
base111
```

<br>
<br>

###MAPS of Under 5 Mortality Rate

```{r install_packages, eval=TRUE, include=FALSE}

if (!require(utilsIPEA)) install.packages("utilsIPEA", repos = "http://cran.us.r-project.org")
if (!require(rgdal)) install.packages("rgdal", repos = "http://cran.us.r-project.org")
if (!require(raster)) install.packages("raster", repos = "http://cran.us.r-project.org")
if (!require(tmaptools)) install.packages("tmaptools", repos = "http://cran.us.r-project.org")
#install.packages("mapshaper", repos = "http://cran.us.r-project.org")
if (!require(tmap)) install.packages("tmap", repos = "http://cran.us.r-project.org")
if (!require(leaflet)) install.packages("leaflet", repos = "http://cran.us.r-project.org")
if (!require(RColorBrewer)) install.packages("RColorBrewer", repos = "http://cran.us.r-project.org")
if (!require(classInt)) install.packages("classInt", repos = "http://cran.us.r-project.org")
if (!require(dplyr)) install.packages("dplyr", repos = "http://cran.us.r-project.org")
library(utilsIPEA)
library(rgdal)
library(raster)
library(tmaptools)
#library(mapshaper)
library(tmap)
library(leaflet)
library(RColorBrewer)
library(classInt)
library(dplyr)

```


```{r package, eval=TRUE, cache=TRUE, include=FALSE}

install.packages("haven", repos = "http://cran.us.r-project.org")
install.packages("ggplot2", repos = "http://cran.us.r-project.org")
install.packages("foreign", repos = "http://cran.us.r-project.org")
library ("haven")
library("ggplot2")
library("foreign")

```

Bringing in mortality and map data

```{r data, include=TRUE}

#link="https://github.com/quinhasf/pubpol-599/raw/master/ape_analysis.dta"
#chw_fp <- read_dta(url(link))

link="https://github.com/ihsun-uw/Group3_Final_Project/raw/master/child_mortality.dta"
df <- read_dta(url(link))

```


```{r map, include=TRUE, eval=TRUE}

zip_mozmap_SHP = "https://github.com/ihsun-uw/Group3_Final_Project/raw/master/Mozambique%20shape%20maps.zip"

```


```{r, eval=TRUE}
library(utils)
temp=tempfile()
download.file(zip_mozmap_SHP, temp)
unzip(temp)
```


```{r, include=FALSE }

#DMC - showing which tempfiles are in the directory

(maps=list.files(pattern = 'shp'))
```


```{r, eval=TRUE, results='hide', warning=FALSE, message=FALSE, echo=FALSE}
# notice the parameters use in the chunk!!

library(rgdal)
mozzipMap <- readOGR("MOZ-level_1.shp",stringsAsFactors=F) 

```



```{r plot_map, eval=TRUE, include=FALSE}

plot(mozzipMap)


```


```{r data_cleaning, eval=TRUE, include=FALSE}

str(chw_fp$province)
str(mozzipMap)
head(chw_fp$province, 10)
names(mozzipMap)
head(mozzipMap$CAPTION, 50)

str(mozzipMap$CAPTION)

#mozzipMap$CAPTION=as.numeric(mozzipMap$CAPTION)

mozzipMap

```


<!-- Generating the list of provinces and assigning a number
1: Cabo Delgado
2: Gaza
3: Inhambane
4: Manica
5: Maputo Provincia
6: Nampula
7: Niassa
8: Sofala
9: Tete
10: Zambezia
-->

```{r recoding_provinces, eval=TRUE, include=FALSE}

#SchoolData$Grade[SchoolData$Grade==5] <- "Grade Five"
chw_fp$province_num <- chw_fp$province

chw_fp$province_num[chw_fp$province=="CABO DELGADO"] <- 1
chw_fp$province_num[chw_fp$province=="GAZA"] <- 2
chw_fp$province_num[chw_fp$province=="INHAMBANE"] <- 3
chw_fp$province_num[chw_fp$province=="MANICA"] <- 4
chw_fp$province_num[chw_fp$province=="MAPUTO PROVINCIA"] <- 5
chw_fp$province_num[chw_fp$province=="NAMPULA"] <- 6
chw_fp$province_num[chw_fp$province=="NIASSA"] <- 7
chw_fp$province_num[chw_fp$province=="SOFALA"] <- 8
chw_fp$province_num[chw_fp$province=="TETE"] <- 9
chw_fp$province_num[chw_fp$province=="ZAMBEZIA"] <- 10


#str(mozzipMap$ID)
#names(mozzipMap)
#mozzipMap

#mozzipMap$province_num <- mozzipMap$ID

mozzipMap$province_num[mozzipMap$ID=="Cabo Delgado"] <- 1
mozzipMap$province_num[mozzipMap$ID=="Gaza"] <- 2
mozzipMap$province_num[mozzipMap$ID=="Inhambane"] <- 3
mozzipMap$province_num[mozzipMap$ID=="Manica"] <- 4
mozzipMap$province_num[mozzipMap$ID=="Maputo"] <- 5
mozzipMap$province_num[mozzipMap$ID=="Nampula"] <- 6
mozzipMap$province_num[mozzipMap$ID=="Niassa"] <- 7
mozzipMap$province_num[mozzipMap$ID=="Sofala"] <- 8
mozzipMap$province_num[mozzipMap$ID=="Tete"] <- 9
mozzipMap$province_num[mozzipMap$ID=="Zambezia"] <- 10
mozzipMap$province_num[mozzipMap$ID=="Maputo (city)"] <- 11

#chw_fp

df$province_num[df$provname=="Cabo Delgado"] <- 1
df$province_num[df$provname=="Gaza"] <- 2
df$province_num[df$provname=="Inhambane"] <- 3
df$province_num[df$provname=="Manica"] <- 4
df$province_num[df$provname=="Maputo Provincia"] <- 5
df$province_num[df$provname=="Nampula"] <- 6
df$province_num[df$provname=="Niassa"] <- 7
df$province_num[df$provname=="Sofala"] <- 8
df$province_num[df$provname=="Tete"] <- 9
df$province_num[df$provname=="Zambezia"] <- 10
df$province_num[df$provname=="Maputo Cidade"] <- 11

#creating new data frame with just the year 2010
df_new <- df[111:121,1:26]

#creating change in u5 mortality rate from 2000 - 2010
df_new$u5_change[df_new$province_num==1] <- 100*(df_new$U5M_COMB[df_new$province_num==1] - df$U5M_COMB[df$province_num==1 & df$year==2000])/df$U5M_COMB[df$province_num==1 & df$year==2000]
df_new$u5_change[df_new$province_num==2] <- 100*(df_new$U5M_COMB[df_new$province_num==2] - df$U5M_COMB[df$province_num==2 & df$year==2000])/df$U5M_COMB[df$province_num==2 & df$year==2000]
df_new$u5_change[df_new$province_num==3] <- 100*(df_new$U5M_COMB[df_new$province_num==3] - df$U5M_COMB[df$province_num==3 & df$year==2000])/df$U5M_COMB[df$province_num==3 & df$year==2000]
df_new$u5_change[df_new$province_num==4] <- 100*(df_new$U5M_COMB[df_new$province_num==4] - df$U5M_COMB[df$province_num==4 & df$year==2000])/df$U5M_COMB[df$province_num==4 & df$year==2000]
df_new$u5_change[df_new$province_num==5] <- 100*(df_new$U5M_COMB[df_new$province_num==5] - df$U5M_COMB[df$province_num==5 & df$year==2000])/df$U5M_COMB[df$province_num==5 & df$year==2000]
df_new$u5_change[df_new$province_num==6] <- 100*(df_new$U5M_COMB[df_new$province_num==6] - df$U5M_COMB[df$province_num==6 & df$year==2000])/df$U5M_COMB[df$province_num==6 & df$year==2000]
df_new$u5_change[df_new$province_num==7] <- 100*(df_new$U5M_COMB[df_new$province_num==7] - df$U5M_COMB[df$province_num==7 & df$year==2000])/df$U5M_COMB[df$province_num==7 & df$year==2000]
df_new$u5_change[df_new$province_num==8] <- 100*(df_new$U5M_COMB[df_new$province_num==8] - df$U5M_COMB[df$province_num==8 & df$year==2000])/df$U5M_COMB[df$province_num==8 & df$year==2000]
df_new$u5_change[df_new$province_num==9] <- 100*(df_new$U5M_COMB[df_new$province_num==9] - df$U5M_COMB[df$province_num==9 & df$year==2000])/df$U5M_COMB[df$province_num==9 & df$year==2000]
df_new$u5_change[df_new$province_num==10] <- 100*(df_new$U5M_COMB[df_new$province_num==10] - df$U5M_COMB[df$province_num==10 & df$year==2000])/df$U5M_COMB[df$province_num==10 & df$year==2000]
df_new$u5_change[df_new$province_num==11] <- 100*(df_new$U5M_COMB[df_new$province_num==11] - df$U5M_COMB[df$province_num==11 & df$year==2000])/df$U5M_COMB[df$province_num==11 & df$year==2000]


```

<br>

###MAP 1
Creating the first map of the under 5 mortality rate by province

```{r layer_plot2, eval=TRUE}

layerContrib_2=merge(mozzipMap,df_new, by.x='province_num', by.y='province_num',all.x=F)

```


```{r define_var_plot2, include=TRUE, eval=TRUE}

varToPlot_2=layerContrib_2$U5M_COMB

```


```{r color_plot2, eval=TRUE, include=TRUE}

numberOfClasses=5
colorForScale='OrRd'
colors = brewer.pal(numberOfClasses, colorForScale)
intervals <- classIntervals(varToPlot_2, numberOfClasses,
                            style = "kmeans",
                            dataPrecision = 0)
                           
colorPallette <- findColours(intervals, colors)

```


<a id='fig5'></a>
```{r plot_2, eval=TRUE, include=TRUE}

legendText="u5 mortality rate"
shrinkLegend=1
title="Under 5 mortality rate in Mozambique by province (2010)"


# first the ORIGINAL to signal missing values:
plot(mozzipMap,col='red',main=title, border="black", lwd=1) 

title(sub=source, adj=0)

# now the info on contributions
plot(layerContrib_2, col = colorPallette,border=NA,add=T) #add

# this uses all previous information
legend('topright', 
       legend = names(attr(colorPallette, "table")), #values
       fill = attr(colorPallette, "palette"), #colors
       cex = shrinkLegend, #size 
       bty = "n", # no box
       title=legendText)
```

<br>


###MAP 2
Generating one more data set for mapping - change in u5 MR

```{r layer_plot3, eval=TRUE}

layerContrib_3=merge(mozzipMap,df_new, by.x='province_num', by.y='province_num',all.x=F)

```


```{r define_var_plot3, include=TRUE, eval=TRUE}

varToPlot_3=layerContrib_2$u5_change

```


```{r color_plot3, eval=TRUE, include=TRUE}

numberOfClasses=5
colorForScale='YlOrRd'
colors = brewer.pal(numberOfClasses, colorForScale)
intervals <- classIntervals(varToPlot_3, numberOfClasses,
                            style = "kmeans",
                            dataPrecision = 0)
                           
colorPallette <- findColours(intervals, colors)

```


<a id='fig6'></a>
```{r plot3, eval=TRUE, include=TRUE}

legendText="Change in u5 mortality"
shrinkLegend=1
title="Percent change in u5 mortality rate in Mozambique by province \n(2000-2010)"

# first the ORIGINAL to signal missing values:
plot(mozzipMap,col='red',main=title, border="black", lwd=1) 

title(sub=source, adj=0)

# now the info on contributions
plot(layerContrib_3, col = colorPallette,border=NA,add=T) #add

# this uses all previous information
legend('topright', 
       legend = names(attr(colorPallette, "table")), #values
       fill = attr(colorPallette, "palette"), #colors
       cex = shrinkLegend, #size 
       bty = "n", # no box
       title=legendText)

```

<br>
<br>


